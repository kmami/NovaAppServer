<!DOCTYPE html> 
<html lang="fr">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-type" content="text/html; charset=UTF-8" />
		<title>Tests chargement dynamique js</title>
		<script src="js/jquery/jquery-1.6.4.js" type="text/javascript"></script>
		  <script type="text/javascript" charset="utf-8" src="phonegap.js"></script>
<!--		<script src="js/crypto/crypto-sha256/crypto-sha256.js"></script>-->
<!--    	<script src="js/novaappserver-1.1.js"  type="text/javascript"></script>		-->
<!--		<script src="js/jquery/jquery.mobile-1.0.min.js"  type="text/javascript"></script>-->
<!--		<link rel="stylesheet"  href="js/jquery/jquery.mobile-1.0.min.css" />  -->
<!--		<script src="js/crypto.pack.js"></script>-->

    </head>
	
	<body>
		<div data-role="page">
			<div data-role="header">
				<h1>Tests chargement dynamique js</h1>
            </div><!-- /Entete de la page -->
 
            <div data-role="content">
				<div id="message-json" style="font-size: 18px; color:blue;"></div>	

 
            <div data-role="footer" data-position="fixed">
                <h4>&copy; <a href="http://www.novaxel.com" title="">Novaxel</a> 2012</h4>
            </div><!-- /Pied de page -->
 
		</div><!-- /Page Login -->
		
		
		
	<script>
	// Instanciation d'un objet novaappserver
	jQuery(document).ready(function() {
		var SCRIPTS_JS = new Array(
			Array('SHA256','js/crypto/crypto-sha256/crypto-sha256.js','Support de hash SHA256','Crypto.SHA256(\'test\')')
			,Array('JSON','js/json2.js','Support des fonctions JSON sur les navigateurs obsolètes','JSON.stringify(["e", {pluribus: "unum"}])')
		);

		// Chargement des librairies JS complémentaires à cette librairie
		if (SCRIPTS_JS.length > 0) { 
			var ajaxSettings = {
				// Soit les valeurs par défaut, soit les valeurs préconisées dans notre contexte...
				// Pas d'évènement ni de converters traité ici pour ne pas compliquer les tests... 
				accepts: 'text/javascript' // Voir si nécessaire (header)
				,async: false // Idéalement, devrait être toujous à false car sinon, je n'aurai pas le "temps" de tester avant de lancer les opérations suivantes...
				,cache: true // Idéalement ceci devrait toujours être True... //km
				,contentType: 'application/x-www-form-urlencoded' // Valeur par défaut pouvant éventuellement être modifiée si nécessaire (impact ???)
				// ,context: // permet d'attacher le résultat à un objet DOM : normalement inutile dans notre contexte
				//,crossDomain: true // permet de forcer une requête crossdomain même si domaine identique, inutile dans noter contexte
				//,data: {} // inutile dans notre contexte...
				,dataType: 'script' // On force en data script (jQuery.ajax utilisé plus loin)
				,global: true // par défaut
				//,headers: {} // header complémentaires, normallement inutile dans notre contexte
				//,ifModified: false // requête OK seulement si les datas ont changées depuis la dernière demande (attention déclenche jQuery.ajax.error même si la requête est Ok...)
				,isLocal: true // À faire varier en function des tests
				,scriptCharset: 'UTF-8' // Normallement ce doit être le cas...
				,timeout: 5000 // 5 secondes
				,type: 'GET' // par défaut pour les scripts....
			};

			jQuery("#message-json").append('<p>Options AJAX : ' + JSON.stringify(ajaxSettings) + '</p>'); // Oui, il faut que cette méthode existe déjà ;-)
			for (var i=0;i<SCRIPTS_JS.length;i++) {
				// On effectue toujours un test de préchargement, de manière à détecter un chargement initialisé par ailleurs (entête HTML <script...>)
				if (SCRIPTS_JS[i][3] !='') {
					try {
						if (eval(SCRIPTS_JS[i][3])) {;
							jQuery("#message-json").append('<p>la librairie "' + SCRIPTS_JS[i][0] + ' (' + SCRIPTS_JS[i][2] +') est déjà chargée ou elle est inutile (fonctionnalités directement prises en charge par le navigateur) !<Pp>' );
							continue; // Eval est Ok, on passe à la libraires suivante...
						}
					}
					catch (err) {}
				}
				// Tentative de chargement du script par jQuery.getScript()...
				jQuery("#message-json").append('<p>Tentative de chargement de la librairie "' + SCRIPTS_JS[i][0] + ' (' + SCRIPTS_JS[i][2] +')"</p>');

				jQuery.ajax(jQuery.extend(
					ajaxSettings,
					{
						url: SCRIPTS_JS[i][1]
					}
				))
				.done(function() {
					jQuery("#message-json").append('<p>Librairie "' + SCRIPTS_JS[i][0] + ' (' + SCRIPTS_JS[i][2] +') correctement chargée !</p>');
					try {
						jQuery("#message-json").append('<p>Test d\'utilisation de la librairie "' + SCRIPTS_JS[i][0] + ' (' + SCRIPTS_JS[i][2] +')" avec l\'expression : "' + SCRIPTS_JS[i][3] + '"...</p>');
						var result = eval(SCRIPTS_JS[i][3]);
						jQuery("#message-json").append('<p>Utilisation de la librairie "' + SCRIPTS_JS[i][0] + ' (' + SCRIPTS_JS[i][2] +')" OK (résulat de l\'expression : "' + result + '") !</p>');
					}
					catch(err) {
						jQuery("#message-json").append('<p>Utilisation de la librairie "' + SCRIPTS_JS[i][0] + ' (' + SCRIPTS_JS[i][2] +')" KO avec l\'erreur suivante<br />' + err.message + '!</p>');
						throw new Error();
						return false;
					}
					return true;
						
				})
				.fail(function(jqxhr, settings, exception) {
					jQuery("#message-json").append('<p>Erreur lors du chargement de la librairie"' + SCRIPTS_JS[i][0] + ' (' + SCRIPTS_JS[i][2] +') - URI : "' + SCRIPTS_JS[i][1] + '" avec l\'erreur suivante : <br />' + 'status : ' + jqxhr.statusText + ' (' + jqxhr.status +  ') - readystate : ' + jqxhr.readyState + ' - erreur : ' + exception + '</p>');
					throw new Error();
					return false;
				});
			}
		}
	});

	</script>	
	
	</body>
</html>